---
title: "Patient Characteristics and racial disparities in determing clinical outcomes among COVID-19 Patients"
author: "Sri Denduluri, Ph.D"
output: 
  html_document:
    toc: false 
    depth: 3 
    theme: paper 
    highlight: tango
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 400)
```  
***
Use this template to complete your project throughout the course. Your Final Project presentation will be based on the contents of this document. Replace the title/name above and text below with your own, but keep the headers.

### Overview
Give a brief a description of your project and its goal(s), what data you are using to complete it, and what three faculty/staff in different fields you have spoken to about your project with a brief summary of what you learned from each person. Include a link to your final project GitHub repository.

According to the published literature, COVID-19 is disproportionately affecting gender,racial, 
and ethnic minorities but patient-level observations of hospital length of stay, ICU status and 
even mortality by race and ethicity are very limited. The objective of this study is to  
systematically determine what patient characteristics and pre-existing health conditions
associated with COVID-19 outcomes and how do they differ by racial/ethnic disparities?


### Introduction 
Describe the problem addressed, its significance, and some background to motivate the problem.

Explain why your problem is interdisciplinary, what fields can contribute to its understanding, and incorporate background related to what you learned from meeting with faculty/staff.

Coronavirus disease is caused by severe acute respiratory syndrome coronavirus 2 (SARS-CoV-2)
and was first detected in Wuhan, China in 2019. The disease has impacted over 150 countries and 
emerged as a global pandemic infecting over 1.5 million patients in the United States as of 
early June 2020. Since the U.S has become the epicenter of this crisis, multiple studies were 
undertaken to study the disease manifestations and patient outcomes to show the impact of this 
crisis nationwide.There is a sharp rise of COVID-19 infections in U.S. and along with population 
concerns have also emerged regarding the COVID-19 infections disproportionately impacting racial/ethnic 
minorities. Multiple studies have been reported that people who belong certain racial and 
ethnic groups have a higher rates of hospitalization. Earlier studies have also reported that 
people who are aged and smoke and those who have had existing co-morbid conditions are mostly 
likely to be affected by COVID-19 with higher infection rates, higher disease severity and even 
mortality. Despite the early studies on these disparities, the substantial evidence supporting 
patient-level studies on the observed disparity with appropriate co-morbid conditions,patient 
characteristics and clinical outcomes differ by race/ethnicity among hospitalized patients with 
COVID-19 are lacking.


### Methods
Describe the data used and general methodological approach. Subsequently, incorporate full R code necessary to 
retrieve and clean data, and perform analysis. Be sure to include a description of code so that others 
(including your future self) can understand what you are doing and why. 


### Study Population: 

The de-identified data sets used for this project were pulled from the PennMedicine's Clarity Database on 
patients who were visited to one of the hospitals at Penn Medicine for COVID-19 test. The study has the approval 
by the Institutional Review Board at the University of Pennsylvania as part of Division of Cardiovascular Medicine 
blanket-IRB approval.

Using SQL-query, first I have pulled the patients who have had COVID-19 confirmed-postive (positive) and 
confirmed-negative (ruled-out). For these patients, I have obtained the demographics and medical comorbidities. 
Demographics included Age, Race,Gender,Ethnicity,Smoking Status,Length of Stay,ICU (yes/no), Ventilator (yes/no),
Category (confirmed or ruled-out), Deceased Status (yes/no) as a first data set.  Comorbid conditions included any 
documented histories of heart failure, hypertension, angina, stroke, hyper-lipidemia, chronic obstructive 
pulmonary disease, 
chronic kidney disease, obesity and asthma respectively for the second data set.

All the patient identifiers were carefully removed and a random number was generated instead to link the data 
between the two data sets. Most of the variables including comorbid conditions were represented as categorical 
variables (yes/no) and age was represented as a numeric variable. A two Excel CSV files were created from the 
above data sets namely i) COVID_Pats.csv and COVID_Comorb.csv and have been loaded into R as a list of data frames 
called Pat_Demo and Pat_Comorb respectively.



```{r eval = TRUE}
  library(dplyr)
  library(ggplot2)

####   PART I ######################
#Data read from CSV files
Pat_Demo = read.csv("C:/Users/Administrator/Downloads/COVID_Pats1.csv",header = TRUE, stringsAsFactors = TRUE)

Pat_Comorb = read.csv("C:/Users/Administrator/Downloads/COVID_Comorb1.csv",header = TRUE, stringsAsFactors = TRUE)
                      
str(Pat_Demo)
str(Pat_Comorb)

# Merged Data Set
Pat_Merged_Data <- merge(Pat_Demo, Pat_Comorb)

#Creating a new data set for analysis
COVID.clean <- Pat_Merged_Data %>% 
        dplyr::select(Age,Race,Gender,Ethnicity,Smoking_Status,LOS,ICU_Dept_YN,Ventilator_YN,Category,Deceased_Status,
        HF,HTN,Diabetes,Angina,Hyperlipidemia,Stroke,COPD,CKD,Obesity,Asthma) %>%
        rename(age = Age,race = Race,gender= Gender,ethnicity = Ethnicity,smoking.status = Smoking_Status,category = Category,
            deceased.status = Deceased_Status,length.of.stay = LOS, icu=ICU_Dept_YN, ventilator = Ventilator_YN) %>%   
        filter(!category  %in% c("Ruled Out"))# %>% 
        #filter(!race  %in% c("Other","Unknown","Patient Declined")) %>% 
       # filter(smoking.status != 'Not Asked') 

  str(COVID.clean)

  # Total Patient Population in the data set
  Total_Pat_counts <- COVID.clean%>% 
  summarize(count = n())

  Total_Pat_counts

## Patient Population by race
  Pat_counts <- COVID.clean%>% 
  group_by(race) %>%
  summarize(count = n())

  Pat_counts

  ## Since there were not many patients of other race, I am taking only White and Black population for 
  # race analysis
race_wb <- COVID.clean %>% 
  filter(race == 'White' | race == 'Black')

#Data set for smoking Yes/No
smoking_set <- COVID.clean %>% 
  filter(smoking.status == 'Yes' | smoking.status == 'No')
 
######### EnD PART I ##################

### PART II Univariate Analysis ###################

# Comparing each selected predictor variable to selected outcome variable
  # ********
  # Predictor variables: age, race, gender, Asthma, Obesity, Diabetes, Hypertension, COPD
  # Outcome variables: ICU, Ventilator, Decease Status
  
# ******** ICU
   #For outcome ICU versus predictor age
    ggplot(COVID.clean, aes(x = icu, y = age)) +
        geom_boxplot()
    summary(glm(icu ~ age, data = COVID.clean, family = "binomial"))
    chisq.test(table(COVID.clean$icu, COVID.clean$age))
    
  #For outcome ICU versus predictor Race
    ggplot(race_wb, aes(x = icu, fill = race)) +
        geom_bar(position = "dodge")
    
    model_r <- glm(formula= icu ~ race, data=race_wb, family=binomial)
    summary(model_r)
    chisq.test(table(race_wb$icu, race_wb$race))
    
    testdatayes_rw <- data.frame(race="White")
    predict(model_r,testdatayes_rw, type="response")
    
    testdatayes_rb =  data.frame(race="Black")
    predict(model_r, testdatayes_rb, type="response")
    
  #For outcome ICU versus predictor Gender
    ggplot(COVID.clean, aes(x = icu, fill = gender)) +
        geom_bar(position = "dodge")
    
    model_g <- glm(formula= icu ~ gender, data=COVID.clean, family=binomial)
    summary(model_g)
    chisq.test(table(COVID.clean$icu, COVID.clean$gender))
    
    testdatayes_gm <- data.frame(gender="Male")
    predict(model_g,testdatayes_gm, type="response")
    
    testdatayes_gf =  data.frame(gender="Female")
    predict(model_g, testdatayes_gf, type="response")
    
    #For outcome ICU versus predictor smoking status
    ggplot(smoking_set, aes(x = icu, fill = smoking.status)) +
        geom_bar(position = "dodge")
    
    model_smo <- glm(formula= icu ~ smoking.status, data=smoking_set, family=binomial)
    summary(model_smo)
    chisq.test(table(smoking_set$icu, smoking_set$smoking.status))
    
    testdatayes_smo <- data.frame(smoking.status="Yes")
    predict(model_smo,testdatayes_smo, type="response")
    
    testdatano_smo =  data.frame(smoking.status="No")
    predict(model_smo, testdatano_smo, type="response")
    
     #For outcome ICU versus predictor Obesity
    ggplot(COVID.clean, aes(x = icu, fill = Obesity)) +
        geom_bar(position = "dodge")
    
    model <- glm(formula= icu ~ Obesity, data=COVID.clean, family=binomial)
    summary(model)
    chisq.test(table(COVID.clean$icu, COVID.clean$Obesity))
    
    testdatayes <- data.frame(Obesity="Y")
    predict(model,testdatayes, type="response")
    
    testdatano =  data.frame(Obesity="N")
    predict(model, testdatano, type="response")
    
# End ICU
    
# ******** Ventilator
   #For outcome ventilator versus predictor age
    ggplot(COVID.clean, aes(x = ventilator, y = age)) +
        geom_boxplot()
    summary(glm(ventilator ~ age, data = COVID.clean, family = "binomial"))
    chisq.test(table(COVID.clean$ventilator, COVID.clean$age))
    
  #For outcome ventilator versus predictor Race
    ggplot(race_wb, aes(x = ventilator, fill = race)) +
        geom_bar(position = "dodge")
    
    model_r <- glm(formula= ventilator ~ race, data=race_wb, family=binomial)
    summary(model_r)
    chisq.test(table(race_wb$ventilator, race_wb$race))
    
    testdatayes_rw <- data.frame(race="White")
    predict(model_r,testdatayes_rw, type="response")
    
    testdatayes_rb =  data.frame(race="Black")
    predict(model_r, testdatayes_rb, type="response")
    
  #For outcome ventilator versus predictor Gender
    ggplot(COVID.clean, aes(x = ventilator, fill = gender)) +
        geom_bar(position = "dodge")
    
    model_g <- glm(formula= ventilator ~ gender, data=COVID.clean, family=binomial)
    summary(model_g)
    chisq.test(table(COVID.clean$ventilator, COVID.clean$gender))
    
    testdatayes_gm <- data.frame(gender="Male")
    predict(model_g,testdatayes_gm, type="response")
    
    testdatayes_gf =  data.frame(gender="Female")
    predict(model_g, testdatayes_gf, type="response")
    
    #For outcome ventilator versus predictor smoking status
    ggplot(smoking_set, aes(x = ventilator, fill = smoking.status)) +
        geom_bar(position = "dodge")
    
    model_smo <- glm(formula= ventilator ~ smoking.status, data=smoking_set, family=binomial)
    summary(model_smo)
    chisq.test(table(smoking_set$ventilator, smoking_set$smoking.status))
    
    testdatayes_smo <- data.frame(smoking.status="Yes")
    predict(model_smo,testdatayes_smo, type="response")
    
    testdatano_smo =  data.frame(smoking.status="No")
    predict(model_smo, testdatano_smo, type="response")
    
     #For outcome ventilator versus predictor Obesity
    ggplot(COVID.clean, aes(x = ventilator, fill = Obesity)) +
        geom_bar(position = "dodge")
    
    model <- glm(formula= ventilator ~ Obesity, data=COVID.clean, family=binomial)
    summary(model)
    chisq.test(table(COVID.clean$ventilator, COVID.clean$Obesity))
    
    testdatayes <- data.frame(Obesity="Y")
    predict(model,testdatayes, type="response")
    
    testdatano =  data.frame(Obesity="N")
    predict(model, testdatano, type="response")
    
# End ventilator
    
# ******** deceased.status
   #For outcome deceased.status versus predictor age
    ggplot(COVID.clean, aes(x = deceased.status, y = age)) +
        geom_boxplot()
    summary(glm(deceased.status ~ age, data = COVID.clean, family = "binomial"))
    chisq.test(table(COVID.clean$deceased.status, COVID.clean$age))
    
  #For outcome deceased.status versus predictor Race
    ggplot(race_wb, aes(x = deceased.status, fill = race)) +
        geom_bar(position = "dodge")
    
    model_r <- glm(formula= deceased.status ~ race, data=race_wb, family=binomial)
    summary(model_r)
    chisq.test(table(race_wb$deceased.status, race_wb$race))
    
    testdatayes_rw <- data.frame(race="White")
    predict(model_r,testdatayes_rw, type="response")
    
    testdatayes_rb =  data.frame(race="Black")
    predict(model_r, testdatayes_rb, type="response")
    
  #For outcome deceased.status versus predictor Gender
    ggplot(COVID.clean, aes(x = deceased.status, fill = gender)) +
        geom_bar(position = "dodge")
    
    model_g <- glm(formula= deceased.status ~ gender, data=COVID.clean, family=binomial)
    summary(model_g)
    chisq.test(table(COVID.clean$deceased.status, COVID.clean$gender))
    
    testdatayes_gm <- data.frame(gender="Male")
    predict(model_g,testdatayes_gm, type="response")
    
    testdatayes_gf =  data.frame(gender="Female")
    predict(model_g, testdatayes_gf, type="response")
    
    #For outcome deceased.status versus predictor smoking status
    ggplot(smoking_set, aes(x = deceased.status, fill = smoking.status)) +
        geom_bar(position = "dodge")
    
    model_smo <- glm(formula= deceased.status ~ smoking.status, data=smoking_set, family=binomial)
    summary(model_smo)
    chisq.test(table(smoking_set$deceased.status, smoking_set$smoking.status))
    
    testdatayes_smo <- data.frame(smoking.status="Yes")
    predict(model_smo,testdatayes_smo, type="response")
    
    testdatano_smo =  data.frame(smoking.status="No")
    predict(model_smo, testdatano_smo, type="response")
    
     #For outcome deceased.status versus predictor Obesity
    ggplot(COVID.clean, aes(x = deceased.status, fill = Obesity)) +
        geom_bar(position = "dodge")
    
    model <- glm(formula= deceased.status ~ Obesity, data=COVID.clean, family=binomial)
    summary(model)
    chisq.test(table(COVID.clean$deceased.status, COVID.clean$Obesity))
    
    testdatayes <- data.frame(Obesity="Y")
    predict(model,testdatayes, type="response")
    
    testdatano =  data.frame(Obesity="N")
    predict(model, testdatano, type="response")
    
# End deceased.status
    
# END PART II Univariate Analysis
    

## group COVID patients by Race and Deceased status
Cat_counts <- COVID.clean %>% 
  filter(race == 'White' | race == 'Black') %>%
  group_by(race,deceased.status) %>%
  summarize(count = n())

ggplot(data = Cat_counts, aes(x = race, y = count, fill = deceased.status)) +
  ggtitle("Deceased Status and Race") +
  geom_bar(stat = 'identity')

##mean average length of stay based on race
Avg_LOS <-COVID.clean  %>% 
  filter(category == 'Confirmed' & race  %in% c("East Indian", "White", "Asian", "Black","HLW-Hispanic Latino/White", 
                      "HLB-Hispanic Latino/Black", "American Indian","Pacific Island ")) %>%
  group_by(race) %>% 
  summarize(AvG_Length_of_Stay = mean(as.numeric(length.of.stay), na.rm=TRUE), counts = n()) %>%
  arrange(desc(AvG_Length_of_Stay))

  Avg_LOS

#average length of stay of patients by race
theme_set(theme_bw())
ggplot(Avg_LOS, aes(x = race, y = AvG_Length_of_Stay)) + 
  geom_bar(stat="identity", width=.5, fill="tomato3") + 
  labs(title="Average length of stay by race", 
       subtitle="Race Vs LOS", 
       caption="Avg LOS") + 
  theme(axis.text.x = element_text(angle=65, vjust=0.6))



#Multivariable regression models for Length of Stay, ICU, Ventilator and Decease Status

los.glm <- glm(length.of.stay ~ as.numeric(age) + gender + race + smoking.status + HF + HTN + Diabetes +
              +Angina + Stroke + COPD + CKD + Obesity + Asthma,data = COVID.clean, family = "binomial")
          summary(los.glm)


icu.glm <- glm(icu ~ as.numeric(age) +  gender + race + smoking.status + HF + HTN + Diabetes +
              +Angina + Stroke + COPD + CKD + Obesity + Asthma,data = COVID.clean, family = "binomial")
          summary(icu.glm)

ventilator.glm <- glm(ventilator ~ as.numeric(age) + gender + race + smoking.status + HF + HTN + Diabetes +
              +Angina + Stroke + COPD + CKD + Obesity + Asthma,data = COVID.clean,family = "binomial")
            summary(ventilator.glm)

deceased.glm <- glm(deceased.status ~ as.numeric(age) + gender + race + smoking.status + HF + HTN + Diabetes +
              +Angina + Stroke + COPD + CKD + Obesity + Asthma,data = COVID.clean,family = "binomial")
            summary(deceased.glm)



#Logistic regression

#find out top variables that are significant based on regression model
decease.glm <- glm(deceased.status ~ as.numeric(age) + gender + race + smoking.status + HF + HTN + Diabetes +
              +Angina + Stroke + COPD + CKD + Obesity + Asthma + ventilator + icu,data = COVID.clean,family = binomial(logit))
summary(decease.glm)

#Logistic regression
#obtained top variables from above step
a4.top.glm <- glm(deceased.status ~ as.numeric(age) +smoking.status + HTN + CKD + Obesity + ventilator + icu, data = COVID.clean, 
                  family = binomial(logit))
summary(a4.top.glm)


glm.top.pred <- predict(a4.top.glm, COVID.clean, type = "response")

#Random Forest
library(randomForest)
rf.top <- randomForest(deceased.status ~ smoking.status + HTN + CKD + Obesity + ventilator + icu, data = COVID.clean, 
                       ntree = 100, importance = TRUE)
rf.top

rf.top$importance

rf.top.pred <- predict(rf.top, COVID.clean, type = "prob")

#10-fold cross-validation
N = nrow(COVID.clean)
K = 10
set.seed(1234)
s = sample(1:K, size = N, replace = T)
pred_outputs.glm <- vector(mode = "numeric", length = N)
pred_outputs.rf <- vector(mode = "numeric", length = N)
obs_outputs <- vector(mode = "numeric", length = N)
offset <- 0
for(i in 1:K){
    train <- filter(COVID.clean, s != i)
    test <- filter(COVID.clean, s == i)
    obs_outputs[1:length(s[s == i]) + offset] <- test$deceased.status
    #GLM train/test
    glm <- glm(deceased.status ~ smoking.status + HTN + CKD + Obesity + ventilator + icu, data = train, family = binomial(logit))
    glm.pred.curr <- predict(glm, test, type = "response")
    pred_outputs.glm[1:length(s[s == i]) + offset] <- glm.pred.curr

    #RF train/test
    rf <- randomForest(deceased.status ~ smoking.status + HTN + CKD + Obesity + ventilator + icu, data = train, ntree = 100)
    rf.pred.curr <- predict(rf, newdata = test, type = "prob") 
    pred_outputs.rf[1:length(s[s == i]) + offset] <- rf.pred.curr[ , 2]

    offset <- offset + length(s[s == i])
}

#ROC Curves
library(pROC)
plot.roc(COVID.clean$deceased.status, glm.top.pred, ci = TRUE, main = "Using Top-Ranked Variables") 
plot.roc(obs_outputs, pred_outputs.glm, ci = TRUE, col = "darkblue", add = TRUE) 
plot.roc(COVID.clean$deceased.status, rf.top.pred[, 2], ci = TRUE, col = "darkgreen", add = TRUE)

plot.roc(obs_outputs, pred_outputs.rf, ci = TRUE, col = "red", add = TRUE) 
legend("bottomright", legend = c("GLM Training", "GLM Cross-Validation", "RF Training", "RF Cross-Validation"), col = c("black", "darkblue", "darkgreen", "red"), lwd = 2)

auc(COVID.clean$deceased.status, glm.top.pred)

auc(obs_outputs, pred_outputs.glm)

auc(COVID.clean$deceased.status, rf.top.pred[ , 2])

auc(obs_outputs, pred_outputs.rf)
``` 



### Results
Describe your results and include relevant tables, plots, and code/comments used to obtain them. End with a brief conclusion of your findings related to the question you set out to address. You can include references if you'd like, but this is not required.
